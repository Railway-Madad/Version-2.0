<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Passenger Dashboard</title>
    <link rel="stylesheet" href="index.css">
</head>

<body>
    <main class="page-shell fade-in">
        <section class="surface-card card-highlight">
            <div class="page-header">
                <div>
                    <h1>Passenger Dashboard</h1>
                    <p id="welcome" class="muted-text">Fetching your details…</p>
                </div>
                <div class="dashboard-actions" style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <a class="btn btn-ghost" href="index.html">Home</a>
                    <a class="btn btn-ghost" href="lostnfound.html">Lost and Found</a>
                    <button class="btn btn-tonal" onclick="logout()">Logout</button>
                </div>
            </div>

            <div class="divider"></div>

            <h2 class="card-section-title">Quick Actions</h2>
            <p>Access the services you need in a single click.</p>

            <div class="link-grid">
                <a class="link-tile" href="complaint.html">
                    <strong>File a Complaint</strong>
                    <span>Raise an issue and monitor progress</span>
                </a>
                <a class="link-tile" href="order.html">
                    <strong>Order Onboard Meals</strong>
                    <span>Browse the live menu and track your order</span>
                </a>
                <a class="link-tile" href="emergency.html">
                    <strong>Emergency Request</strong>
                    <span>Notify the control room for urgent help</span>
                </a>
                <a class="link-tile" href="feedback.html">
                    <strong>Share Feedback</strong>
                    <span>Help us improve your journey experience</span>
                </a>
            </div>
        </section>

        <section class="surface-card">
            <div class="page-header">
                <div>
                    <h2>Latest News &amp; Updates</h2>
                    <p class="muted-text">Stay informed with important announcements from Indian Railways.</p>
                </div>
            </div>
            <div id="news-section"></div>
        </section>
    </main>

    <script>
        async function loadDashboard() {
            const token = localStorage.getItem("token");
            if (!token) {
                window.location.href = "login.html";
                return;
            }

            const res = await fetch("http://localhost:4000/", {
                headers: { "Authorization": `Bearer ${token}` }
            });

            if (res.ok) {
                const data = await res.json();
                document.getElementById("welcome").innerText = `Hello, ${data.username}!`;
            } else {
                localStorage.removeItem("token");
                window.location.href = "login.html";
            }
        }

        function logout() {
            localStorage.removeItem("token");
            window.location.href = "login.html";
        }

        loadDashboard();
    </script>

    <script>
        const API_BASE = "http://localhost:4000";

        async function loadNews() {
            const container = document.getElementById("news-section");
            container.innerHTML = "<p class=\"muted-text\">Loading the latest updates…</p>";

            try {
                const res = await fetch(`${API_BASE}/news`);
                const data = await res.json();
                container.innerHTML = "";

                if (!data.data || data.data.length === 0) {
                    container.innerHTML = "<p class=\"muted-text\">No announcements have been published yet.</p>";
                    return;
                }

                data.data.forEach(n => {
                    const card = document.createElement("article");
                    card.className = "news-card";

                    const hasImage = Boolean(n.imageUrl);
                    card.innerHTML = `
                        ${hasImage ? `<img src="${n.imageUrl}" alt="${n.title}">` : ""}
                        <div class="news-card__body">
                            <h3>${n.title}</h3>
                            <p>${n.description || ""}</p>
                            <time>Posted on ${new Date(n.createdAt).toLocaleString()}</time>
                        </div>
                    `;

                    container.appendChild(card);
                });
            } catch (error) {
                console.error(error);
                container.innerHTML = "<p class=\"message error\">Unable to load news at the moment.</p>";
            }
        }

        loadNews();
    </script>
</body>

</html>
