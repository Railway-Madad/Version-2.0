<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
     <main>
        <section>
            <h2>Menu</h2>
            <div id="menu-container">
                <!-- menu -->
            </div>
        </section>

        <section>
            <h2>Your Order</h2>
            <div id="cart-items">
                <!-- cart -->
            </div>
            <div>
            </div>
            <form id="order-form">
  <h3>Delivery Details</h3>
  <p>We only accept Pay on Delivery.</p>
  
  <label for="address">Delivery Seat Number and Coach number:</label><br>
  <textarea id="address" name="address" rows="2" placeholder="Enter your delivery address" required></textarea><br><br>
  
  <label for="notes">Additional Notes:</label><br>
  <textarea id="notes" name="notes" rows="3" placeholder="Any special instructions?"></textarea><br><br>
  
  <button type="submit" id="place-order">Place Order</button>
</form>
<div id="order-message"></div>
        </section>
        <section>
            <h2>My Past Orders</h2>
            <button id="load-orders-btn">Load My Orders</button>
            <div id="past-orders-container">
                <!-- past order -->
            </div>
        </section>
    </main>
</body>

<script>

const token = localStorage.getItem('token');
const API_BASE = "http://localhost:4000"; 
let cart = [];
if (!token) {
    window.location.href = "login.html";
}

//display menu
async function loadMenu() {
  try {
    const res = await fetch(`${API_BASE}/food`);
    const data = await res.json();
    if (!data.success) throw new Error("Failed to load menu");

    const menuContainer = document.getElementById("menu-container");
    menuContainer.innerHTML = "";

    data.data.forEach(food => {
      const div = document.createElement("div");
      div.classList.add("menu-item");
      div.innerHTML = `
        <img src="${food.imageUrl}" alt="${food.name}" width="100">
        <h3>${food.name}</h3>
        <p>${food.description || ""}</p>
        <p><strong>₹${food.price}</strong></p>
        <button onclick="addToCart('${food._id}', '${food.name}', ${food.price})">Add to Cart</button>
      `;
      menuContainer.appendChild(div);
    });
  } catch (err) {
    console.error(err);
  }
}


function addToCart(foodId, name, price) {
  const existing = cart.find(item => item.foodItem === foodId);
  if (existing) existing.quantity++;
  else cart.push({ foodItem: foodId, name, price, quantity: 1 });
  renderCart();
}

function renderCart() {
  const cartDiv = document.getElementById("cart-items");
  cartDiv.innerHTML = "";
  let total = 0;

  cart.forEach((item, i) => {
    total += item.price * item.quantity;
    const div = document.createElement("div");
    div.innerHTML = `
      <p>${item.name} x ${item.quantity} = ₹${item.price * item.quantity}</p>
      <button onclick="changeQty(${i}, 1)">+</button>
      <button onclick="changeQty(${i}, -1)">-</button>
      <button onclick="removeItem(${i})">Remove</button>
    `;
    cartDiv.appendChild(div);
  });

  const totalDiv = document.createElement("div");
  totalDiv.innerHTML = `<h4>Total: ₹${total}</h4>`;
  cartDiv.appendChild(totalDiv);
}

function changeQty(index, delta) {
  cart[index].quantity += delta;
  if (cart[index].quantity <= 0) cart.splice(index, 1);
  renderCart();
}

function removeItem(index) {
  cart.splice(index, 1);
  renderCart();
}   

// place order
document.getElementById("order-form").addEventListener("submit", async e => {
  e.preventDefault();

  const notes = document.getElementById("notes").value.trim();
  const deliveryAddress = document.getElementById("address").value.trim();

  if (!deliveryAddress) {
    alert("Please enter a delivery address.");
    return;
  }

  if (cart.length === 0) {
    alert("Your cart is empty!");
    return;
  }

  try {
    const body = {
      items: cart.map(c => ({
        foodItem: c.foodItem,
        quantity: c.quantity,
      })),
      deliveryAddress,
      notes,
    };

    const res = await fetch(`${API_BASE}/catering/order`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`,
      },
      body: JSON.stringify(body),
    });

    const data = await res.json();
    const messageDiv = document.getElementById("order-message");

    if (data.success) {
      messageDiv.innerText = "Order placed successfully!";
      cart = [];
      renderCart();
      document.getElementById("order-form").reset();
    } else {
      messageDiv.innerText = "❌ " + (data.message || "Failed to place order");
    }
  } catch (err) {
    console.error(err);
  }
});

document.getElementById("load-orders-btn").addEventListener("click", async () => {
  try {
    const res = await fetch(`${API_BASE}/catering/my-orders`, {
      headers: {
        Authorization: `Bearer ${token}`,
      },
    });

    const data = await res.json();
    const container = document.getElementById("past-orders-container");
    container.innerHTML = "";

    if (!data.success || data.data.length === 0) {
      container.innerHTML = "<p>No past orders found.</p>";
      return;
    }

    data.data.forEach(order => {
      const div = document.createElement("div");
      div.classList.add("order-card");
      div.innerHTML = `
  <h4>Order #${order._id}</h4>
  <p>Status: <strong>${order.status}</strong></p>
  <p>Total: ₹${order.totalPrice}</p>
  <ul>
    ${order.items
      .map(
        i =>
          `<li>${i.foodItem.name} x ${i.quantity} (₹${i.priceAtOrder})</li>`
      )
      .join("")}
  </ul>
  <p><strong>Address:</strong> ${order.deliveryAddress}</p>
  <small>Placed on: ${new Date(order.createdAt).toLocaleString()}</small>
  <br>
  ${
    order.status === "pending" || order.status === "preparing"
      ? `<button onclick="cancelOrder('${order._id}')">Cancel Order</button>`
      : ""
  }
`;

      container.appendChild(div);
    });
  } catch (err) {
    console.error(err);
  }
});

async function cancelOrder(orderId) {
  const confirmCancel = confirm("Are you sure you want to cancel this order?");
  if (!confirmCancel) return;

  try {
    const res = await fetch(`${API_BASE}/catering/${orderId}/status`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`,
      },
      body: JSON.stringify({ status: "cancelled" }),
    });

    const data = await res.json();

    if (data.success) {
      alert("✅ Order cancelled successfully!");
      document.getElementById("load-orders-btn").click(); // reload orders
    } else {
      alert("❌ " + (data.message || "Failed to cancel order"));
    }
  } catch (err) {
    console.error(err);
  }
}


loadMenu();


</script>

</html>
