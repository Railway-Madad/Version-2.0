<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Onboard Meal Service</title>
    <link rel="stylesheet" href="index.css">
</head>
<body>
    <main class="page-shell fade-in">
        <section class="surface-card card-highlight">
            <div class="page-header">
                <div>
                    <h1>Onboard Meal Service</h1>
                    <p class="muted-text">Explore curated meals, build your cart, and track delivery without leaving your seat.</p>
                </div>
                <a class="btn btn-tonal" href="userDashboard.html">Back to Dashboard</a>
            </div>
        </section>

        <section class="content-grid two-column">
            <article class="surface-card">
                <div class="page-header">
                    <div>
                        <h2>Menu</h2>
                        <p class="muted-text">Freshly prepared options updated by the catering team.</p>
                    </div>
                </div>
                <div id="menu-container" class="menu-grid"></div>
            </article>

            <article class="surface-card">
                <div class="page-header">
                    <div>
                        <h2>Your Cart</h2>
                        <p class="muted-text">Adjust quantities or remove items before placing your order.</p>
                    </div>
                </div>
                <div id="cart-items" class="cart-list"></div>
            </article>
        </section>

        <section class="surface-card">
            <div class="page-header">
                <div>
                    <h2>Delivery Details</h2>
                    <p class="muted-text">We currently support pay-on-delivery only.</p>
                </div>
            </div>
            <form id="order-form" class="form-grid">
                <div class="input-group">
                    <label for="address">Delivery Seat Number and Coach number</label>
                    <textarea id="address" name="address" rows="2" placeholder="Enter your delivery details" required></textarea>
                </div>
                <div class="input-group">
                    <label for="notes">Additional Notes</label>
                    <textarea id="notes" name="notes" rows="3" placeholder="Any special instructions?"></textarea>
                </div>
                <button class="btn" type="submit" id="place-order">Place Order</button>
            </form>
            <p id="order-message" class="message" role="alert"></p>
        </section>

        <section class="surface-card">
            <div class="page-header">
                <div>
                    <h2>My Past Orders</h2>
                    <p class="muted-text">Review order history and monitor fulfilment statuses.</p>
                </div>
                <button class="btn btn-tonal" id="load-orders-btn" type="button">Load My Orders</button>
            </div>
            <div id="past-orders-container" class="orders-list"></div>
        </section>
    </main>

<script>
  const token = localStorage.getItem('token');
  const API_BASE = "http://localhost:4000";
  let cart = [];

  if (!token) {
    window.location.href = "login.html";
  }

  // =================== LOAD MENU ===================
  async function loadMenu() {
    const menuContainer = document.getElementById("menu-container");
    menuContainer.innerHTML = "<div class=\"empty-state\">Loading menu...</div>";

    try {
      const res = await fetch(`${API_BASE}/food`);
      const data = await res.json();
      if (!data.success) throw new Error("Failed to load menu");

      menuContainer.innerHTML = "";

      if (!data.data || data.data.length === 0) {
        menuContainer.innerHTML = "<div class=\"empty-state\">Menu will be available shortly.</div>";
        return;
      }

      data.data.forEach(food => {
        const priceValue = Number(food.price) || 0;
        const card = document.createElement("article");
        card.classList.add("menu-card");
        card.innerHTML = `
        ${food.imageUrl ? `<img class="menu-card__image" src="${food.imageUrl}" alt="${food.name}">` : ""}
        <div class="menu-card__body">
          <div>
            <h3>${food.name}</h3>
            <p class="muted-text">${food.description || ""}</p>
          </div>
          <div class="actions-inline" style="justify-content: space-between;">
            <span class="menu-card__price">&#8377;${priceValue.toFixed(2)}</span>
            <button class="btn btn-ghost" type="button" onclick="addToCart('${food._id}', '${food.name}', ${priceValue})">Add to Cart</button>
          </div>
        </div>
      `;
        menuContainer.appendChild(card);
      });
    } catch (err) {
      console.error(err);
      menuContainer.innerHTML = "<div class=\"empty-state\">Unable to load menu at the moment.</div>";
    }
  }

  // =================== CART FUNCTIONS ===================
  function addToCart(foodId, name, price) {
    const existing = cart.find(item => item.foodItem === foodId);
    if (existing) existing.quantity++;
    else cart.push({ foodItem: foodId, name, price, quantity: 1 });
    renderCart();
  }

  function renderCart() {
    const cartDiv = document.getElementById("cart-items");
    cartDiv.innerHTML = "";

    if (cart.length === 0) {
      cartDiv.innerHTML = "<div class=\"empty-state\">Your cart is currently empty.</div>";
      return;
    }

    let total = 0;

    cart.forEach((item, i) => {
      total += item.price * item.quantity;
      const card = document.createElement("div");
      card.className = "cart-item";
      card.innerHTML = `
      <div class="cart-item__header">
        <div>
          <strong>${item.name}</strong>
          <p class="muted-text">Quantity: ${item.quantity}</p>
        </div>
        <span class="menu-card__price">&#8377;${(item.price * item.quantity).toFixed(2)}</span>
      </div>
      <div class="cart-item__actions">
        <button type="button" onclick="changeQty(${i}, 1)">+</button>
        <button type="button" onclick="changeQty(${i}, -1)">-</button>
        <button type="button" onclick="removeItem(${i})">Remove</button>
      </div>
    `;
      cartDiv.appendChild(card);
    });

    const totalDiv = document.createElement("div");
    totalDiv.className = "cart-item";
    totalDiv.innerHTML = `
    <div class="cart-item__header">
      <strong>Total</strong>
      <span class="menu-card__price">&#8377;${total.toFixed(2)}</span>
    </div>
  `;
    cartDiv.appendChild(totalDiv);
  }

  function changeQty(index, delta) {
    cart[index].quantity += delta;
    if (cart[index].quantity <= 0) cart.splice(index, 1);
    renderCart();
  }

  function removeItem(index) {
    cart.splice(index, 1);
    renderCart();
  }

  // =================== PLACE ORDER ===================
  document.getElementById("order-form").addEventListener("submit", async e => {
    e.preventDefault();

    const deliveryAddress = document.getElementById("address").value.trim();
    const notes = document.getElementById("notes").value.trim();
    const messageDiv = document.getElementById("order-message");
    messageDiv.classList.remove("success", "error");
    messageDiv.innerText = "";

    if (!deliveryAddress) {
      alert("Please enter a delivery address.");
      return;
    }

    if (cart.length === 0) {
      alert("Your cart is empty!");
      return;
    }

    try {
      const body = {
        items: cart.map(c => ({
          foodItem: c.foodItem, // Only the ID (backend will populate)
          quantity: c.quantity,
        })),
        deliveryAddress,
        notes,
      };

      const res = await fetch(`${API_BASE}/catering/order`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify(body),
      });

      const data = await res.json();

      if (data.success) {
        messageDiv.innerText = "Order placed successfully!";
        messageDiv.classList.add("success");
        cart = [];
        renderCart();
        document.getElementById("order-form").reset();
      } else {
        messageDiv.innerText = "Warning: " + (data.message || "Failed to place order");
        messageDiv.classList.add("error");
      }
    } catch (err) {
      console.error(err);
      messageDiv.innerText = "Unable to process your order right now.";
      messageDiv.classList.add("error");
    }
  });

  // =================== LOAD PAST ORDERS ===================
  document.getElementById("load-orders-btn").addEventListener("click", async () => {
    const container = document.getElementById("past-orders-container");
    container.innerHTML = "<div class=\"empty-state\">Fetching your orders...</div>";

    try {
      const res = await fetch(`${API_BASE}/catering/my-orders`, {
        headers: { Authorization: `Bearer ${token}` },
      });

      const data = await res.json();
      if (!data.success || data.data.length === 0) {
        container.innerHTML = "<div class=\"empty-state\">No past orders found.</div>";
        return;
      }

      container.innerHTML = "";

      for (const order of data.data) {
        // Resolve each order item. Backend sometimes returns a populated `foodItem` object
        // (with name/price) or only the foodItem ID string. Handle both cases and
        // fetch details only when necessary.
        console.log('order.items:', order.items);

        const resolvedItems = await Promise.all(
          order.items.map(async i => {
            try {
              // If backend already populated the foodItem as an object, use it directly
              if (i.foodItem && typeof i.foodItem === 'object' && i.foodItem.name) {
                return {
                  name: i.foodItem.name || 'Unknown Item',
                  quantity: i.quantity,
                  price: (i.priceAtOrder != null ? i.priceAtOrder : (i.foodItem.price || 0)),
                };
              }

              // Determine the ID when foodItem is a string or an object with _id
              const foodId = typeof i.foodItem === 'string' ? i.foodItem : (i.foodItem && i.foodItem._id) ? i.foodItem._id : null;
              if (!foodId) {
                return { name: 'Unknown Item', quantity: i.quantity, price: i.priceAtOrder || 0 };
              }

              const foodRes = await fetch(`${API_BASE}/food/${foodId}`, {
                headers: { Authorization: `Bearer ${token}` },
              });
              const foodData = await foodRes.json();
              const food = foodData.data || foodData;
              return {
                name: food.name || 'Unknown Item',
                quantity: i.quantity,
                price: (i.priceAtOrder != null ? i.priceAtOrder : (food.price || 0)),
              };
            } catch (err) {
              console.error('Failed to resolve order item', i, err);
              return { name: 'Unknown Item', quantity: i.quantity, price: i.priceAtOrder || 0 };
            }
          })
        );

        const statusClass =
          order.status === "delivered"
            ? "status-pill success"
            : order.status === "cancelled"
              ? "status-pill danger"
              : "status-pill warning";

        const div = document.createElement("article");
        div.classList.add("order-card");
  div.innerHTML = `
        <div class="order-card__header">
          <div>
            <h4>Order #${order._id}</h4>
            <p class="muted-text">${new Date(order.createdAt).toLocaleString()}</p>
          </div>
          <span class="${statusClass}">${order.status}</span>
        </div>
        <p><strong>Total:</strong> &#8377;${order.totalPrice}</p>
        <ul class="past-order-items">
          ${resolvedItems
            .map(i => `<li>${i.name} Ã— ${i.quantity} (&#8377;${Number(i.price || 0).toFixed(2)})</li>`)
            .join('')}
        </ul>
        <p><strong>Address:</strong> ${order.deliveryAddress}</p>
        ${order.status === "pending" || order.status === "preparing"
            ? `<button class="btn btn-tonal" type="button" onclick="cancelOrder('${order._id}')">Cancel Order</button>`
            : ""
          }
      `;
        container.appendChild(div);
      }
    } catch (err) {
      console.error(err);
      container.innerHTML = "<div class=\"empty-state\">Unable to load your orders.</div>";
    }
  });

  // =================== CANCEL ORDER ===================
  async function cancelOrder(orderId) {
    const confirmCancel = confirm("Are you sure you want to cancel this order?");
    if (!confirmCancel) return;

    try {
      const res = await fetch(`${API_BASE}/catering/${orderId}/status`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({ status: "cancelled" }),
      });

      const data = await res.json();

      if (data.success) {
        alert("Success! Order cancelled successfully.");
        document.getElementById("load-orders-btn").click();
      } else {
        alert("Warning: " + (data.message || "Failed to cancel order"));
      }
    } catch (err) {
      console.error(err);
    }
  }

  loadMenu();
</script>

</body>

</html>
