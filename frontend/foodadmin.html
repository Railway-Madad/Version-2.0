<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
</head>
<body>
  <h1>Admin Food Dashboard</h1>

  <section>
    <h2>Add New Food Item</h2>
    <form id="add-food-form" enctype="multipart/form-data">
      <input type="text" id="name" name="name" placeholder="Name" required />
      <input type="number" id="price" name="price" placeholder="Price" required />
      <input type="text" id="description" name="description" placeholder="Description" />
      <input type="text" id="category" name="category" placeholder="Category" />
      <input type="file" id="image" name="image" accept="image/*" />
      <button type="submit">Add Food</button>
    </form>
    <div id="add-food-message"></div>
  </section>

  <section>
    <h2>Menu Items</h2>
    <div id="menu-container"></div>
  </section>

  <section>
    <h2>All Orders & Stats</h2>
    <button id="load-orders-btn">Load Orders</button>
    <div id="stats"></div>
    <div id="orders-container"></div>
  </section>

  <script>
    const API_BASE = "http://localhost:4000";

window.onload = () => {
  loadMenu();
};

async function loadMenu() {
  const container = document.getElementById("menu-container");
  container.innerText = "Loading menu...";
  try {
    const res = await fetch(`${API_BASE}/food`);
    const data = await res.json();
    if (!data.success) {
      container.innerText = "Failed to load menu.";
      return;
    }
    console.log(data);

    container.innerHTML = "";
    data.data.forEach(food => {
      const div = document.createElement("div");
      div.style.border = "1px solid black";
      div.style.margin = "10px";
      div.style.padding = "10px";
      div.innerHTML = `
        <p><b>${food.name}</b> - ₹${food.price}</p>
        <p>${food.description || ""}</p>
        <p><i>${food.category || ""}</i></p>
        ${food.imageUrl ? `<img src="${food.imageUrl}" width="100">` : ""}
        <button onclick="deleteFood('${food._id}')">Delete</button>
      `;
      container.appendChild(div);
    });
  } catch (err) {
    console.error(err);
    container.innerText = "Error loading menu.";
  }
}

document.getElementById("add-food-form").addEventListener("submit", async e => {
  e.preventDefault();
  const formData = new FormData(e.target);

  try {
    const res = await fetch(`${API_BASE}/food`, {
      method: "POST",
      body: formData,
    });

    const data = await res.json();
    const msg = document.getElementById("add-food-message");

    if (data.success) {
      msg.innerText = "✅ Food item added successfully!";
      e.target.reset();
      loadMenu();
    } else {
      msg.innerText = "❌ " + (data.message || "Failed to add food");
    }
  } catch (err) {
    console.error(err);
  }
});

// Delete food item
async function deleteFood(id) {
  if (!confirm("Are you sure you want to delete this item?")) return;

  try {
    const res = await fetch(`${API_BASE}/food/${id}`, {
      method: "DELETE",
    });
    const data = await res.json();
    if (data.success) {
      alert("✅ Deleted successfully");
      loadMenu();
    } else {
      alert("❌ " + (data.message || "Failed to delete"));
    }
  } catch (err) {
    console.error(err);
  }
}

// Load all orders and show stats
document.getElementById("load-orders-btn").addEventListener("click", loadOrders);

async function loadOrders() {
  const statsDiv = document.getElementById("stats");
  const container = document.getElementById("orders-container");
  container.innerHTML = "Loading...";
  try {
    const res = await fetch(`${API_BASE}/catering/all-orders`);
    const data = await res.json();
    if (!data.success) {
      container.innerText = "Failed to load orders.";
      return;
    }

    const orders = data.data;
    container.innerHTML = "";

    // Stats
    const totalOrders = orders.length;
    const totalRevenue = orders.reduce((sum, o) => sum + o.totalPrice, 0);
    const delivered = orders.filter(o => o.status === "delivered").length;
    const pending = orders.filter(o => o.status === "pending").length;
    const preparing = orders.filter(o => o.status === "preparing").length;
    const outForDelivery = orders.filter(o => o.status === "out for delivery").length;

    statsDiv.innerHTML = `
      <h3>Order Statistics:</h3>
      <p>Total Orders: ${totalOrders}</p>
      <p>Pending: ${pending}</p>
      <p>Preparing: ${preparing}</p>
      <p>Out for Delivery: ${outForDelivery}</p>
      <p>Delivered: ${delivered}</p>
      <p>Total Revenue: ₹${totalRevenue}</p>
    `;

    // Orders display
    orders.forEach(order => {
      const div = document.createElement("div");
      div.style.border = "1px solid black";
      div.style.margin = "10px";
      div.style.padding = "10px";
      div.innerHTML = `
        <p><b>Order ID:</b> ${order._id}</p>
        <p><b>User:</b> ${order.user?.name || "N/A"} (${order.user?.email || ""})</p>
        <p><b>Status:</b> ${order.status}</p>
        <p><b>Total:</b> ₹${order.totalPrice}</p>
        <p><b>Address:</b> ${order.deliveryAddress}</p>
        <ul>
          ${order.items.map(i => `<li>${i.foodItem?.name} × ${i.quantity}</li>`).join("")}
        </ul>
      `;
      container.appendChild(div);
    });
  } catch (err) {
    console.error(err);
    container.innerText = "Error loading orders.";
  }
}

  </script>
</body>
</html>
